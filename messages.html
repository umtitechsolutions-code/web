<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages - UMTI Tech</title>
    <link rel="icon" type="image/png" href="assets/images/umti-20tech-transparent-20-20only-20logo.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['Outfit', 'sans-serif'] } } } }</script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="css/portal-styles.css">
    <link rel="stylesheet" href="css/variables.css">
    <style>
        body {
            background-color: #f8fafc;
        }
    </style>
</head>

<body class="font-sans">
    <!-- Sidebar -->
    <aside id="sidebar" class="portal-sidebar">
        <div class="flex items-center gap-3 mb-8 px-2">
            <div
                class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center p-1.5">
                <img src="assets/images/umti-20tech-transparent-20-20only-20logo.png" alt="UMTI Tech"
                    class="w-full h-full object-contain">
            </div>
            <span class="text-xl font-bold text-slate-900">UMTI<span class="text-indigo-600">Tech</span></span>
        </div>
        <nav id="dynamicSidebar" class="space-y-2"></nav>

        <div class="mt-auto pt-8">
            <button onclick="Auth.logout()" class="portal-nav-link w-full text-red-600 hover:bg-red-50">
                <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Header -->
    <header class="portal-header">
        <button id="mobileMenuBtn" class="lg:hidden p-2 hover:bg-slate-100 rounded-lg">
            <i data-lucide="menu" class="w-6 h-6"></i>
        </button>
        <div class="flex items-center gap-4 ml-auto">
            <button class="p-2 hover:bg-slate-100 rounded-lg relative">
                <i data-lucide="bell" class="w-5 h-5"></i>
                <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>
            <div class="flex items-center gap-3">
                <div
                    class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center text-white font-bold">
                    <span id="headerInitial">U</span>
                </div>
                <div class="hidden sm:block">
                    <p class="text-sm font-semibold text-slate-900" id="headerName">User</p>
                    <p class="text-xs text-slate-500" id="headerEmail">user@example.com</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="portal-content h-screen flex flex-col">
        <div class="h-[calc(100vh-140px)] flex flex-col space-y-6">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 shrink-0">
                <div class="animate-slide-in-left">
                    <h1 class="text-2xl md:text-3xl lg:text-4xl font-bold text-slate-900 tracking-tight mb-1">
                        Communications <span class="gradient-text">Hub</span>
                    </h1>
                    <p class="text-xs md:text-sm text-slate-500 font-medium tracking-wide">Secure real-time connection.
                    </p>
                </div>
                <button onclick="purgeMessages()"
                    class="rounded-xl border border-red-50 text-red-500 hover:bg-red-50 font-black text-[10px] uppercase tracking-widest px-6 h-12 shadow-sm transition-all">
                    Delete History
                </button>
            </div>

            <div class="flex-1 flex gap-6 overflow-hidden min-h-0 relative">
                <!-- Users Sidebar (Admin Only) or Support Contact (Users) -->
                <div
                    class="flex md:w-80 lg:w-96 glass-card rounded-[2.5rem] overflow-hidden flex-col border-none shadow-xl bg-white/40 backdrop-blur-2xl h-full transition-all duration-300">
                    <div class="p-6 border-b border-slate-100/50">
                        <div class="relative group">
                            <i data-lucide="search"
                                class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                            <input type="text" placeholder="Search..."
                                class="w-full pl-11 rounded-2xl bg-slate-50 border-transparent focus:bg-white h-12 text-sm font-bold shadow-inner outline-none">
                        </div>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 space-y-2 custom-scrollbar" id="usersList">
                        <!-- Users loaded here -->
                    </div>
                </div>

                <!-- Chat Area -->
                <div
                    class="flex-1 glass-card rounded-[2.5rem] overflow-hidden flex-col border-none shadow-2xl relative bg-white/40 backdrop-blur-2xl h-full flex">
                    <div
                        class="p-4 border-b border-slate-100/50 flex items-center gap-4 bg-white/60 backdrop-blur-xl sticky top-0 z-30">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center text-white font-bold shadow-md">
                                <span id="chatHeaderInitial">A</span>
                            </div>
                            <div class="flex flex-col">
                                <span
                                    class="font-black uppercase tracking-widest text-slate-900 text-[10px] leading-none mb-0.5"
                                    id="chatHeaderName">Admin Support</span>
                                <span class="text-[7px] font-bold text-emerald-500 uppercase tracking-widest">Active
                                    Connection</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex-1 p-8 overflow-y-auto space-y-6 custom-scrollbar scroll-smooth"
                        id="messagesContainer">
                        <!-- Messages loaded here -->
                    </div>

                    <!-- Input Area -->
                    <div class="p-6 bg-white/90 backdrop-blur-xl border-t border-slate-100/50 relative z-20">
                        <form onsubmit="sendMessage(event)" class="flex gap-4 max-w-5xl mx-auto">
                            <input type="text" id="messageInput" placeholder="Type your message..."
                                class="flex-1 rounded-2xl bg-slate-50/50 border-transparent focus:bg-white transition-all h-14 pl-6 text-base font-medium shadow-inner outline-none">
                            <button type="submit"
                                class="rounded-2xl bg-slate-900 hover:bg-indigo-600 w-14 h-14 p-0 shadow-xl flex items-center justify-center text-white transition-colors">
                                <i data-lucide="send" class="w-5 h-5"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/utils/auth.js"></script>
    <script src="js/utils/portal-api.js"></script>
    <script src="js/components/portal-layout.js"></script>
    <script>
        Auth.protectPage();
        const currentUser = Auth.getCurrentUser();
        const role = currentUser.role;

        // Reuse sidebar logic

        let myId = null;

        async function loadMessages() {
            try {
                // Get my profile first to identify messages
                const me = await PortalAPI.getProfile();
                myId = me.id;

                // Load Users List
                const usersListDiv = document.getElementById('usersList');
                if (role === 'admin') {
                    const { users } = await PortalAPI.getUsers();
                    usersListDiv.innerHTML = users.filter(u => u.id !== myId).map(user => `
                        <button onclick="selectUser(${user.id}, '${user.name}')" class="w-full p-4 rounded-2xl flex items-center gap-4 transition-all hover:bg-white/60 text-slate-600 text-left">
                            <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center font-bold text-slate-600 text-xs text-indigo-600">
                                ${user.name.charAt(0)}
                            </div>
                            <div>
                                <p class="font-black text-xs uppercase tracking-widest leading-tight">${user.name}</p>
                                <p class="text-[10px] text-slate-400 truncate font-medium">${user.role}</p>
                            </div>
                        </button>
                    `).join('');
                } else {
                    // For non-admins, show Admin as the target
                    usersListDiv.innerHTML = `
                        <button onclick="selectUser(1, 'Admin Support')" class="w-full p-4 rounded-2xl flex items-center gap-4 transition-all bg-slate-900 text-white shadow-xl translate-x-1 text-left">
                            <div class="w-10 h-10 rounded-xl bg-indigo-500 flex items-center justify-center text-white shrink-0 shadow-lg shadow-indigo-200">
                                <i data-lucide="shield-check" class="w-5 h-5"></i>
                            </div>
                            <div class="overflow-hidden">
                                <p class="font-black text-xs uppercase tracking-widest leading-tight">Admin Support</p>
                                <p class="text-[10px] text-slate-400 truncate font-medium">Concierge Service</p>
                            </div>
                        </button>
                    `;
                    window.selectedReceiverId = 1;
                }

                // Load Messages
                const messages = await PortalAPI.getMessages();
                renderMessages(messages);
            } catch (error) {
                console.error("Failed to load messages:", error);
            }
        }

        function renderMessages(messages) {
            const container = document.getElementById('messagesContainer');
            if (messages.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full text-center p-6">
                        <div class="w-24 h-24 bg-slate-50 rounded-full flex items-center justify-center mb-6 shadow-inner">
                            <i data-lucide="message-square" class="w-10 h-10 text-slate-200"></i>
                        </div>
                        <h3 class="text-xl font-black text-slate-900">Spectrum Silence</h3>
                        <p class="text-sm text-slate-400 italic">Start the first transmission.</p>
                    </div>
                `;
            } else {
                container.innerHTML = messages.map(msg => {
                    const isMe = msg.sender_id === myId;
                    return `
                        <div class="flex ${isMe ? 'justify-end' : 'justify-start'} animate-slide-in-up">
                            <div class="flex items-end gap-3 max-w-[75%] ${isMe ? 'flex-row-reverse' : 'flex-row'}">
                                <div class="w-10 h-10 rounded-full bg-indigo-100 border-2 border-white shadow-lg flex items-center justify-center text-xs font-bold shrink-0 text-indigo-600">
                                    ${isMe ? 'Me' : 'U'}
                                </div>
                                <div class="flex flex-col">
                                    <div class="chat-bubble ${isMe ? 'sent' : 'received'}">
                                        <p class="font-medium italic">"${msg.content}"</p>
                                        <div class="mt-2 flex items-center justify-end gap-1 text-[8px] font-black uppercase tracking-widest ${isMe ? 'text-slate-500' : 'text-slate-400'}">
                                            ${new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })} 
                                            ${isMe ? '<i data-lucide="check" class="w-3 h-3 text-emerald-500"></i>' : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                container.scrollTop = container.scrollHeight;
            }
            lucide.createIcons();
        }

        function selectUser(id, name) {
            window.selectedReceiverId = id;
            console.log("Selected user:", id, name);
            // Visual feedback could be added here
        }

        async function sendMessage(e) {
            e.preventDefault();
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            if (!text || !window.selectedReceiverId) return;

            try {
                await PortalAPI.sendMessage(window.selectedReceiverId, text);
                input.value = '';
                await loadMessages(); // Reload to show new message
            } catch (error) {
                console.error("Failed to send message:", error);
                alert("Failed to send message.");
            }
        }

        function purgeMessages() {
            if (confirm("Clear history?")) {
                document.getElementById('messagesContainer').innerHTML = '';
            }
        }

        loadMessages();
    </script>
</body>

</html>